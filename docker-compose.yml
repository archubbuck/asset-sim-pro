version: "3.8"

services:
  sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=LocalDevPassword123!
    ports:
      - "1433:1433"
    volumes:
      - sql-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'LocalDevPassword123!' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10  # SQL Server takes longer to initialize on first start
      start_period: 10s

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service
    volumes:
      - azurite-data:/data
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 -l /data
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:10000/devstoreaccount1?comp=list || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Note: Using community image as Microsoft does not publish an official
  # SignalR emulator Docker image to mcr.microsoft.com. The emulator is
  # distributed as a .NET global tool. This community image packages it.
  signalr-emulator:
    image: klabbet/signalr-emulator:1.0.0-preview1-10809
    ports:
      - "8888:8888"
    environment:
      - Azure__SignalR__Emulator__Upstream__UrlPrefix=http://host.docker.internal:7071
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8888/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

volumes:
  sql-data:
  redis-data:
  azurite-data:
