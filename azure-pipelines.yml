# Azure DevOps Pipeline for AssetSim Pro (Container-Based)
# ADR-023: Container Build & Deploy Pipeline
# 
# Pipeline Stages:
# 1. Build (Cloud): Build Docker images and push to Azure Container Registry
# 2. Database (VNet): Run idempotent SQL migrations from VNet-connected agent
# 3. Deploy (Cloud): Update Container Apps with new images

trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'assetsim-prod-vars' # Links to Azure Key Vault for secrets
  - name: terraform_version
    value: '1.7.0'
  - name: acrName
    value: 'acrassetsimprod'
  - name: acrLoginServer
    value: 'acrassetsimprod.azurecr.io'
  - name: imageTag
    value: '$(Build.BuildId)'

stages:
  # ============================================================================
  # STAGE 1: BUILD AND PUSH CONTAINER IMAGES
  # ============================================================================
  - stage: Build
    displayName: 'Build Container Images'
    jobs:
      - job: BuildImages
        steps:
          # Login to Azure Container Registry
          - task: Docker@2
            inputs:
              command: login
              containerRegistry: 'ACR-Service-Connection'
            displayName: 'Login to Azure Container Registry'

          # Build and push client image
          - task: Docker@2
            inputs:
              command: buildAndPush
              repository: 'client'
              dockerfile: 'apps/client/Dockerfile'
              containerRegistry: 'ACR-Service-Connection'
              tags: |
                $(imageTag)
                latest
              arguments: '--build-arg KENDO_UI_LICENSE=$(KENDO_UI_LICENSE)'
            displayName: 'Build and Push Client Image'

          # Build and push backend image
          - task: Docker@2
            inputs:
              command: buildAndPush
              repository: 'backend'
              dockerfile: 'apps/backend/Dockerfile'
              containerRegistry: 'ACR-Service-Connection'
              tags: |
                $(imageTag)
                latest
            displayName: 'Build and Push Backend Image'

  # ============================================================================
  # STAGE 2: DATABASE MIGRATIONS
  # ============================================================================
  - stage: Database
    displayName: 'Database Migrations'
    dependsOn: Build
    jobs:
      - job: RunMigrations
        pool:
          name: 'Self-Hosted-VNet-Pool' # MUST be inside VNet to reach SQL Server
        steps:
          # Checkout code for database schema
          - checkout: self

          # Run idempotent SQL schema script
          - script: |
              # Install sqlcmd if not present
              if ! command -v sqlcmd &> /dev/null; then
                echo "Installing SQL Server command-line tools..."
                curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
                curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
                sudo apt-get update
                sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
              fi
              
              # Run schema script (idempotent with IF NOT EXISTS guards)
              echo "Running database schema migrations..."
              /opt/mssql-tools18/bin/sqlcmd -S "$(SQL_SERVER)" -U "$(SQL_USERNAME)" -P "$(SQL_PASSWORD)" -d AssetSimPro -C -i database/schema.sql
              
              echo "Database migrations completed successfully"
            displayName: 'Run SQL Schema Migrations'

  # ============================================================================
  # STAGE 3: DEPLOY CONTAINER APPS
  # ============================================================================
  - stage: Deploy
    displayName: 'Deploy Container Apps'
    dependsOn: Database
    jobs:
      - job: UpdateContainerApps
        steps:
          # Update backend Container App with new image
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Updating backend Container App..."
                az containerapp update \
                  --name ca-assetsim-backend-prod \
                  --resource-group rg-assetsim-prod-useast2 \
                  --image $(acrLoginServer)/backend:$(imageTag) \
                  --set-env-vars \
                    NODE_ENV=production \
                    FUNCTIONS_WORKER_RUNTIME=node
                
                echo "Backend Container App updated successfully"
            displayName: 'Update Backend Container App'

          # Update client Container App with new image
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Updating client Container App..."
                az containerapp update \
                  --name ca-assetsim-client-prod \
                  --resource-group rg-assetsim-prod-useast2 \
                  --image $(acrLoginServer)/client:$(imageTag)
                
                echo "Client Container App updated successfully"
            displayName: 'Update Client Container App'

          # Verify deployment health
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'Azure-Service-Connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Verifying Container Apps health..."
                
                # Check backend health
                BACKEND_URL=$(az containerapp show \
                  --name ca-assetsim-backend-prod \
                  --resource-group rg-assetsim-prod-useast2 \
                  --query properties.configuration.ingress.fqdn -o tsv)
                
                echo "Backend FQDN: $BACKEND_URL"
                
                # Check client health
                CLIENT_URL=$(az containerapp show \
                  --name ca-assetsim-client-prod \
                  --resource-group rg-assetsim-prod-useast2 \
                  --query properties.configuration.ingress.fqdn -o tsv)
                
                echo "Client FQDN: https://$CLIENT_URL"
                echo "Deployment completed successfully!"
            displayName: 'Verify Deployment Health'
