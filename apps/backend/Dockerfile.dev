# Development Dockerfile for AssetSim Pro Backend
# This runs Azure Functions in watch mode with hot reload via bind mounts
# Also runs database initialization script on container startup

FROM node:22-bullseye

WORKDIR /app

# Install Azure Functions Core Tools and utilities
RUN apt-get update && \
    apt-get install -y curl gnupg netcat && \
    curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg && \
    mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg && \
    echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-debian-bullseye-prod bullseye main" > /etc/apt/sources.list.d/dotnetdev.list && \
    apt-get update && \
    apt-get install -y azure-functions-core-tools-4 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package*.json ./
COPY apps/backend/package*.json ./apps/backend/

# Install dependencies (will be overridden by bind mount in docker-compose)
RUN npm ci --legacy-peer-deps

# Copy source and build (needed for init-container script)
COPY . .
RUN npx nx build backend

# Expose Azure Functions port
EXPOSE 7071

# Set working directory to backend app
WORKDIR /app/apps/backend

# Environment variable to enable DB init in development
ENV RUN_DB_INIT=true

# Create startup script that runs init then starts Functions
RUN echo '#!/bin/bash\n\
set -e\n\
echo "[dev-container] Starting AssetSim Pro Backend (Development)"\n\
\n\
# Run database initialization if enabled\n\
if [ "$RUN_DB_INIT" = "true" ]; then\n\
  echo "[dev-container] Running database initialization..."\n\
  cd /app && node dist/apps/backend/lib/init-container.js || echo "[dev-container] Init script failed or not found"\n\
  cd /app/apps/backend\n\
fi\n\
\n\
# Start Azure Functions in watch mode\n\
echo "[dev-container] Starting Azure Functions runtime..."\n\
exec func start --javascript --port 7071\n\
' > /app/start-dev.sh && chmod +x /app/start-dev.sh

# Start Azure Functions with watch mode (func start automatically watches for changes)
CMD ["/app/start-dev.sh"]
